#!/bin/sh -e

LIBOGG_TAR="http://downloads.xiph.org/releases/ogg/libogg-1.3.2.tar.gz"
LIBVORBIS_TAR="http://downloads.xiph.org/releases/vorbis/libvorbis-1.3.4.tar.gz"
LIBTHEORA_TAR="http://downloads.xiph.org/releases/theora/libtheora-1.1.1.tar.gz"
LIBSPEEX_TAR="http://downloads.xiph.org/releases/speex/speex-1.2rc1.tar.gz"
LIBKATE_TAR="https://libkate.googlecode.com/files/libkate-0.4.1.tar.gz"
OPUS_TAR="http://downloads.xiph.org/releases/opus/opus-1.1.tar.gz"
LIBXML2_TAR="ftp://xmlsoft.org/libxslt/libxml2-2.9.1.tar.gz"
LIBXSLT_TAR="ftp://xmlsoft.org/libxslt/libxslt-1.1.28.tar.gz"
ICECAST_TAR="http://downloads.xiph.org/releases/icecast/icecast-2.4.0.tar.gz"

CPU_CORES=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || sysctl -n hw.ncpu)
MAKE_OPTS="-j$CPU_CORES"

VENDORED_ICECAST="$1/vendor/icecast"

BP_DIR=$(cd $(dirname $0); cd ..; pwd)

# Downlad dependencies
echo "-----> Downloading icecast source dependencies"

mkdir -p /tmp/libogg
mkdir -p /tmp/libvorbis
mkdir -p /tmp/libspeex
mkdir -p /tmp/libkate
mkdir -p /tmp/opus
mkdir -p /tmp/libtheora
mkdir -p /tmp/libxml2
mkdir -p /tmp/libxslt
mkdir -p /tmp/icecast

curl -q "$LIBOGG_TAR"    | tar -xz -C /tmp/libogg    -f - --strip 1
curl -q "$LIBVORBIS_TAR" | tar -xz -C /tmp/libvorbis -f - --strip 1
curl -q "$LIBSPEEX_TAR"  | tar -xz -C /tmp/libspeex  -f - --strip 1
curl -q "$LIBKATE_TAR"   | tar -xz -C /tmp/libkate   -f - --strip 1
curl -q "$LIBTHEORA_TAR" | tar -xz -C /tmp/libtheora -f - --strip 1
curl -q "$OPUS_TAR"      | tar -xz -C /tmp/opus      -f - --strip 1
#curl -q "$LIBXML2_TAR"   | tar -xz -C /tmp/libxml2   -f - --strip 1
#curl -q "$LIBXSLT_TAR"   | tar -xz -C /tmp/libxslt   -f - --strip 1
curl -q "$ICECAST_TAR"   | tar -xz -C /tmp/icecast   -f - --strip 1

cd /tmp/icecast
echo "--> Applying Heroku specific patches to icecast"
patch -p1 < $BP_DIR/patches/log-to-stderr.patch
patch -p1 < $BP_DIR/patches/read-port-from-environment.patch
#patch < $BP_DIR/patches/remove-explicit-port-mapping-m3u.patch

echo "-----> Compiling dependencies and icecast server"

mkdir -p "$VENDORED_ICECAST"
mkdir -p "$VENDORED_ICECAST/var/log/icecast"

export LD_LIBRARY_PATH=$VENDORED_ICECAST/lib:$LD_LIBRARY_PATH
export PATH=$VENDORED_ICECAST/bin:$PATH

echo "--> Compiling libogg"
cd /tmp/libogg
./configure --quiet --prefix="$VENDORED_ICECAST"
make $MAKE_OPTS
make install

echo "--> Compiling libvorbis"
cd /tmp/libvorbis
./configure --quiet --prefix="$VENDORED_ICECAST" --with-ogg="$VENDORED_ICECAST"
make $MAKE_OPTS
make install

echo "--> Compiling libspeex"
cd /tmp/libspeex
./configure --quiet --prefix="$VENDORED_ICECAST"
make $MAKE_OPTS
make install

echo "--> Compiling libtheora"
cd /tmp/libtheora
./configure --quiet --prefix="$VENDORED_ICECAST" --with-ogg="$VENDORED_ICECAST" --with-vorbis="$VENDORED_ICECAST"
make $MAKE_OPTS
make install

echo "--> Compiling libkate"
cd /tmp/libkate
./configure --quiet --prefix="$VENDORED_ICECAST"
make $MAKE_OPTS
make install

echo "--> Compiling opus"
cd /tmp/opus
./configure --quiet --prefix="$VENDORED_ICECAST"
make $MAKE_OPTS
make install

#echo "--> Compiling libxml2"
#cd /tmp/libxml2
#./configure --prefix="$VENDORED_ICECAST"
#make
#make install

#echo "--> Compiling libxslt"
#cd /tmp/libxslt
#./configure --prefix="$VENDORED_ICECAST"
#make
#make install

echo "--> Compiling icecast"
./configure --quiet --prefix="$VENDORED_ICECAST" --with-ogg="$VENDORED_ICECAST" --with-vorbis="$VENDORED_ICECAST"
make $MAKE_OPTS
make install
